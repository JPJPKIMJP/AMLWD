<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMLWD Admin Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .admin-header {
            background: #333;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        button {
            padding: 5px 10px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-block {
            background-color: #dc3545;
            color: white;
        }
        .btn-unblock {
            background-color: #28a745;
            color: white;
        }
        .btn-suspend {
            background-color: #ffc107;
            color: black;
        }
        .error {
            color: red;
            margin: 10px 0;
        }
        .success {
            color: green;
            margin: 10px 0;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1>üõ°Ô∏è AMLWD Admin Dashboard</h1>
        <div id="adminInfo"></div>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="section">
        <h2>Admin Login</h2>
        <p>Only authorized administrators can access this dashboard.</p>
        <input type="email" id="adminEmail" placeholder="Admin Email">
        <input type="password" id="adminPassword" placeholder="Password">
        <button onclick="adminLogin()">Login</button>
        <div id="loginMessage"></div>
    </div>

    <!-- Admin Dashboard (Hidden until authenticated) -->
    <div id="adminDashboard" class="hidden">
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="dailyImages">0</div>
                <div class="stat-label">Images Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="dailyCost">$0.00</div>
                <div class="stat-label">Cost Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="monthlyImages">0</div>
                <div class="stat-label">Images This Month</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="monthlyCost">$0.00</div>
                <div class="stat-label">Cost This Month</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="blockedUsers">0</div>
                <div class="stat-label">Blocked Users</div>
            </div>
        </div>

        <!-- User Management -->
        <div class="section">
            <h2>User Management</h2>
            <input type="text" id="userSearch" placeholder="Search by email or user ID" style="width: 300px;">
            <button onclick="searchUsers()">Search</button>
            <button onclick="loadAllUsers()">Show All Users</button>
            <div id="userMessage"></div>
            <table id="usersTable" style="margin-top: 20px;">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>User ID</th>
                        <th>Images Today</th>
                        <th>Last Request</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersList">
                    <!-- Users will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Recent Violations -->
        <div class="section">
            <h2>Recent Content Violations</h2>
            <button onclick="loadViolations()">Refresh</button>
            <table style="margin-top: 20px;">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>User</th>
                        <th>Prompt</th>
                        <th>Reason</th>
                        <th>IP</th>
                    </tr>
                </thead>
                <tbody id="violationsList">
                    <!-- Violations will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Recent Generations -->
        <div class="section">
            <h2>Recent Image Generations</h2>
            <button onclick="loadRecentGenerations()">Refresh</button>
            <table style="margin-top: 20px;">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>User</th>
                        <th>Prompt</th>
                        <th>Size</th>
                        <th>Time (ms)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="generationsList">
                    <!-- Generations will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBcNvNxNOLW8zVzgO1OhNFzfr0lDor3ud0",
            authDomain: "amlwd-image-gen.firebaseapp.com",
            projectId: "amlwd-image-gen",
            storageBucket: "amlwd-image-gen.firebasestorage.app",
            messagingSenderId: "402827177676",
            appId: "1:402827177676:web:eaa6fc5165af0f91bd9c69"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();
        
        // Check auth state
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Check if user is admin
                const idTokenResult = await user.getIdTokenResult();
                if (idTokenResult.claims.admin) {
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    document.getElementById('adminInfo').textContent = `Admin: ${user.email}`;
                    loadDashboard();
                } else {
                    auth.signOut();
                    showMessage('loginMessage', 'You are not authorized as an admin', 'error');
                }
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.add('hidden');
            }
        });
        
        // Admin login
        async function adminLogin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                showMessage('loginMessage', error.message, 'error');
            }
        }
        
        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load statistics
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                
                // Daily stats
                const dailyQuery = await db.collection('image_generations')
                    .where('timestamp', '>=', todayStart)
                    .where('success', '==', true)
                    .get();
                
                document.getElementById('dailyImages').textContent = dailyQuery.size;
                document.getElementById('dailyCost').textContent = `$${(dailyQuery.size * 0.003).toFixed(2)}`;
                
                // Monthly stats
                const monthlyQuery = await db.collection('image_generations')
                    .where('timestamp', '>=', monthStart)
                    .where('success', '==', true)
                    .get();
                
                document.getElementById('monthlyImages').textContent = monthlyQuery.size;
                document.getElementById('monthlyCost').textContent = `$${(monthlyQuery.size * 0.003).toFixed(2)}`;
                
                // User stats
                const usersQuery = await db.collection('users').get();
                document.getElementById('totalUsers').textContent = usersQuery.size;
                
                const blockedQuery = await db.collection('blocked_users').get();
                document.getElementById('blockedUsers').textContent = blockedQuery.size;
                
                // Load recent data
                loadRecentGenerations();
                loadViolations();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        // Load all users
        async function loadAllUsers() {
            try {
                const usersQuery = await db.collection('users').limit(50).get();
                displayUsers(usersQuery.docs);
            } catch (error) {
                showMessage('userMessage', 'Error loading users: ' + error.message, 'error');
            }
        }
        
        // Search users
        async function searchUsers() {
            const search = document.getElementById('userSearch').value.trim();
            if (!search) return;
            
            try {
                let query;
                if (search.includes('@')) {
                    query = await db.collection('users').where('email', '==', search).get();
                } else {
                    query = await db.collection('users').doc(search).get();
                    if (query.exists) {
                        displayUsers([query]);
                        return;
                    }
                }
                displayUsers(query.docs || []);
            } catch (error) {
                showMessage('userMessage', 'Error searching users: ' + error.message, 'error');
            }
        }
        
        // Display users
        async function displayUsers(userDocs) {
            const tbody = document.getElementById('usersList');
            tbody.innerHTML = '';
            
            for (const doc of userDocs) {
                const userData = doc.data();
                const userId = doc.id;
                
                // Check if blocked
                const blockedDoc = await db.collection('blocked_users').doc(userId).get();
                const isBlocked = blockedDoc.exists;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${userData.email || 'N/A'}</td>
                    <td>${userId}</td>
                    <td>${userData.requestCount || 0}</td>
                    <td>${userData.lastRequestTime ? new Date(userData.lastRequestTime.toDate()).toLocaleString() : 'Never'}</td>
                    <td>${isBlocked ? 'üö´ Blocked' : '‚úÖ Active'}</td>
                    <td>
                        ${isBlocked ? 
                            `<button class="btn-unblock" onclick="manageUser('${userId}', 'unblock')">Unblock</button>` :
                            `<button class="btn-suspend" onclick="manageUser('${userId}', 'suspend')">Suspend 24h</button>
                             <button class="btn-block" onclick="manageUser('${userId}', 'block')">Block</button>`
                        }
                    </td>
                `;
            }
        }
        
        // Manage user (block/unblock)
        async function manageUser(userId, action) {
            const reason = action === 'unblock' ? '' : prompt('Reason for ' + action + ':');
            if (action !== 'unblock' && !reason) return;
            
            try {
                const manageUserFunc = functions.httpsCallable('manageUser');
                await manageUserFunc({ userId, action, reason, duration: action === 'suspend' ? 24 : null });
                showMessage('userMessage', `User ${action}ed successfully`, 'success');
                searchUsers(); // Refresh
            } catch (error) {
                showMessage('userMessage', 'Error: ' + error.message, 'error');
            }
        }
        
        // Load recent generations
        async function loadRecentGenerations() {
            try {
                const query = await db.collection('image_generations')
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                const tbody = document.getElementById('generationsList');
                tbody.innerHTML = '';
                
                query.forEach(doc => {
                    const data = doc.data();
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A'}</td>
                        <td>${data.userEmail || 'N/A'}</td>
                        <td>${(data.prompt || '').substring(0, 50)}...</td>
                        <td>${data.width}x${data.height}</td>
                        <td>${data.processingTime || 'N/A'}</td>
                        <td>${data.success ? '‚úÖ' : '‚ùå'}</td>
                    `;
                });
            } catch (error) {
                console.error('Error loading generations:', error);
            }
        }
        
        // Load violations
        async function loadViolations() {
            try {
                const query = await db.collection('content_violations')
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                const tbody = document.getElementById('violationsList');
                tbody.innerHTML = '';
                
                query.forEach(doc => {
                    const data = doc.data();
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A'}</td>
                        <td>${data.userEmail || 'N/A'}</td>
                        <td>${(data.prompt || '').substring(0, 50)}...</td>
                        <td>${data.reason || 'N/A'}</td>
                        <td>${data.ip || 'N/A'}</td>
                    `;
                });
            } catch (error) {
                console.error('Error loading violations:', error);
            }
        }
        
        // Show message
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = type;
            setTimeout(() => {
                element.textContent = '';
            }, 5000);
        }
    </script>
</body>
</html>