<!DOCTYPE html>
<html>
<head>
    <title>Check LoRAs in LocalStorage</title>
</head>
<body>
    <h1>LoRAs in LocalStorage</h1>
    <div id="loras"></div>
    
    <h2>Test Firebase Function</h2>
    <button onclick="testGeneration()">Test Generation with NSFW V2</button>
    <div id="status"></div>
    
    <script>
    // Check localStorage
    const customLoras = JSON.parse(localStorage.getItem('customLoras') || '{}');
    const lorasDiv = document.getElementById('loras');
    
    if (Object.keys(customLoras).length === 0) {
        lorasDiv.innerHTML = '<p>No LoRAs found in localStorage</p>';
    } else {
        let html = '<ul>';
        for (const [key, lora] of Object.entries(customLoras)) {
            html += `<li>
                <strong>${lora.name}</strong> (key: ${key})<br>
                URL: ${lora.url}<br>
                Size: ${(lora.fileSize / 1024 / 1024).toFixed(2)} MB<br>
                Uploaded: ${new Date(lora.uploadedAt).toLocaleString()}
            </li>`;
        }
        html += '</ul>';
        lorasDiv.innerHTML = html;
    }
    
    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyBcNvNxNOLW8zVzgO1OhNFzfr0lDor3ud0",
        authDomain: "amlwd-image-gen.firebaseapp.com",
        projectId: "amlwd-image-gen",
        storageBucket: "amlwd-image-gen.firebasestorage.app",
        messagingSenderId: "402827177676",
        appId: "1:402827177676:web:eaa6fc5165af0f91bd9c69"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const functions = firebase.functions();
    
    async function testGeneration() {
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = 'Testing...';
        
        const user = auth.currentUser;
        if (!user) {
            statusDiv.innerHTML = 'Please log in first at https://amlwd-image-gen.web.app/';
            return;
        }
        
        try {
            const generateImage = functions.httpsCallable('generateImageSecure');
            
            // Find NSFW V2 LoRA
            let nsfw_lora = null;
            for (const [key, lora] of Object.entries(customLoras)) {
                if (lora.name.toLowerCase().includes('nsfw')) {
                    nsfw_lora = { key, ...lora };
                    break;
                }
            }
            
            if (!nsfw_lora) {
                statusDiv.innerHTML = 'NSFW V2 LoRA not found in localStorage';
                return;
            }
            
            statusDiv.innerHTML = `Found NSFW LoRA: ${nsfw_lora.name}<br>Testing generation...`;
            
            const result = await generateImage({
                prompt: "a simple red circle",
                width: 512,
                height: 512,
                lora_name: nsfw_lora.key,
                lora_url: nsfw_lora.url,
                lora_strength: 0.8
            });
            
            statusDiv.innerHTML = 'Success! Check console for result.';
            console.log('Result:', result);
            
        } catch (error) {
            statusDiv.innerHTML = `Error: ${error.message}`;
            console.error('Full error:', error);
        }
    }
    
    // Auto-login status
    auth.onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('status').innerHTML = `Logged in as: ${user.email}`;
        }
    });
    </script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
</body>
</html>